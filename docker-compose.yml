version: '3.8'

services:
  # UNS Infrastructure Main Application
  unsinfra-ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: unsinfra-ui
    ports:
      - "8080:8080"     # Main HTTP port
      - "5001:5001"     # MCP Server port (if enabled)
    volumes:
      - unsinfra-data:/app/data    # SQLite database persistence
      - ./logs:/app/logs           # Application logs (optional)
    environment:
      # Database Configuration
      - Storage__Provider=SQLite
      - Storage__ConnectionString=Data Source=/app/data/unsinfra.db
      - Storage__EnableWalMode=true
      - HistoricalStorage__Enabled=true
      - HistoricalStorage__StorageType=SQLite
      - HistoricalStorage__SQLite__DatabasePath=/app/data/unsinfra-historical.db
      - HistoricalStorage__SQLite__EnableWAL=true
      - HistoricalStorage__SQLite__RetentionDays=365
      
      # MQTT Configuration (adjust as needed)
      - Mqtt__BrokerHost=mosquitto
      - Mqtt__BrokerPort=1883
      - Mqtt__UseTls=false
      - Mqtt__ClientId=UNSInfra-Docker-Client
      - Mqtt__AutoReconnect=true
      
      # SocketIO Configuration
      - SocketIO__ServerUrl=https://virtualfactory.online:3000
      - SocketIO__EnableReconnection=true
      
      # ASP.NET Core Configuration
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - DOTNET_RUNNING_IN_CONTAINER=true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - mosquitto

  # MQTT Broker (Eclipse Mosquitto)
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: mosquitto
    ports:
      - "1883:1883"     # MQTT port
      - "9001:9001"     # WebSocket port
    volumes:
      - mosquitto-config:/mosquitto/config
      - mosquitto-data:/mosquitto/data
      - mosquitto-logs:/mosquitto/log
    restart: unless-stopped
    command: mosquitto -c /mosquitto-no-auth.conf
    healthcheck:
      test: ["CMD", "mosquitto_pub", "-h", "localhost", "-t", "test", "-m", "health-check"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Optional: Database Administration Tool
  adminer:
    image: adminer:4.8.1
    container_name: adminer
    ports:
      - "8081:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=sqlite
    restart: unless-stopped
    volumes:
      - unsinfra-data:/var/lib/sqlite:ro  # Read-only access to SQLite databases
    profiles:
      - admin  # Only start with: docker-compose --profile admin up

volumes:
  # Persistent storage for SQLite databases
  unsinfra-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data
  
  # MQTT broker data
  mosquitto-config:
    driver: local
  mosquitto-data:
    driver: local
  mosquitto-logs:
    driver: local

networks:
  default:
    name: unsinfra-network
    driver: bridge